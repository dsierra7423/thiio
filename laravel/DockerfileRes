# laravel/Dockerfile
FROM php:8.1-fpm-alpine

# Install necessary extensions
#RUN docker-php-ext-install pdo pdo_mysql

# Install PHP extensions and other dependencies
RUN docker-php-ext-install pdo pdo_mysql \
    && apk add --no-cache bash git openssh

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Set working directory
WORKDIR /var/www

# Copy the composer files
COPY . composer.json ./
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

RUN mkdir -p ./database/seeders
RUN mkdir -p ./database/factories

# Generate the artisan script (ensure it exists)
RUN php -r "file_exists('artisan') || copy('vendor/laravel/framework/src/Illuminate/Foundation/Console/stubs/artisan', 'artisan');"

# Generate key for Laravel application
RUN php artisan key:generate

# Optimize Laravel application
RUN php artisan optimize

# Install dependencies and optimize autoloader
RUN composer install --no-interaction --no-plugins --no-scripts --prefer-dist 

# Copy the rest of the application code
COPY . .

# Expose port
EXPOSE 9000

# Entry point to run migrations and start PHP-FPM
CMD php artisan migrate --force && php artisan db:seed --force && php-fpm
